stages:
  - build-frontend
  - build-backend
  - docker-deploy

variables:
  CACHE_NPM_PATH: webapp/node_modules/
  CACHE_MAVEN_PATH: .m2/repository
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: tcp://docker:2375
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - $CACHE_NPM_PATH
    - $CACHE_MAVEN_PATH

############################
# Frontend Build
############################
build-frontend:
  image: node:20
  stage: build-frontend
  script:
    - cd webapp
    - npm ci --include=dev
    - npx ng version
    - npx ng build --configuration production --optimization=false
  artifacts:
    paths:
      - webapp/dist/

############################
# Backend Build - Auth Service
############################
build-Auth-Service:
  image: maven:3.9.6-eclipse-temurin-21
  stage: build-backend
  
  services:
    - name: postgres:15-alpine
      alias: postgres-db
      
  variables:
    # 1. Initialize the Postgres Container
    POSTGRES_DB: $POSTGRES_DB       # maps to your secret variable
    POSTGRES_USER: $DB_USERNAME     # maps to your secret variable
    POSTGRES_PASSWORD: $DB_PASSWORD # maps to your secret variable
    
    # 2. Variables for Spring Boot (matches application.yml placeholders)
    DB_HOST: postgres-db            # Tells Spring to use the service alias
    DB_NAME: $POSTGRES_DB
    DB_PORT: 5432
    # DB_USERNAME/PASSWORD are inherited automatically from GitLab secrets
    HIBERNATE_DDL_AUTO: create-drop # Forces clean table creation for tests

  before_script:
    - apt-get update && apt-get install -y netcat-openbsd
    - echo "Waiting for postgres-db..."
    - |
      for i in {1..30}; do
        if nc -z postgres-db 5432; then
          echo "Database is ready!"
          break
        fi
        echo "Waiting..."
        sleep 1
      done

  script:
    - cd backend/Auth-Service
    # No need for long arguments now; application.yml reads the variables above!
    - mvn clean install
  
  artifacts:
    paths:
      - backend/Auth-Service/target/

############################
# Backend Build - User Service
############################
build-User-Service:
  image: maven:3.9.6-eclipse-temurin-21
  stage: build-backend
  
  services:
    - name: postgres:15-alpine
      alias: postgres-db
      
  variables:
    POSTGRES_DB: $POSTGRES_DB
    POSTGRES_USER: $DB_USERNAME
    POSTGRES_PASSWORD: $DB_PASSWORD
    DB_HOST: postgres-db
    DB_NAME: $POSTGRES_DB
    DB_PORT: 5432
    HIBERNATE_DDL_AUTO: create-drop

  before_script:
    - apt-get update && apt-get install -y netcat-openbsd
    - echo "Waiting for postgres-db..."
    - |
      for i in {1..30}; do
        if nc -z postgres-db 5432; then
          echo "Database is ready!"
          break
        fi
        echo "Waiting..."
        sleep 1
      done

  script:
    - cd backend/User-Service
    - mvn clean install
  
  artifacts:
    paths:
      - backend/User-Service/target/

############################
# Docker Build & Push
############################
docker-deploy:
  image: docker:24.0.5
  stage: docker-deploy
  services:
    - name: docker:24.0.5-dind
      alias: docker
  
  needs:
    - build-frontend
    - build-Auth-Service
    - build-User-Service
  
  before_script:
    - docker login -u "$DOCKER_USER" -p "$DOCKER_PASSWORD" docker.io
  
  script:
    - docker build -f webapp/DockerFile -t docker.io/$DOCKER_USER/indianfoodrestro-frontend:latest webapp
    - docker push docker.io/$DOCKER_USER/indianfoodrestro-frontend:latest

    - docker build -f backend/Auth-Service/DockerFile -t docker.io/$DOCKER_USER/indianfoodrestro-auth-service:latest backend/Auth-Service
    - docker push docker.io/$DOCKER_USER/indianfoodrestro-auth-service:latest

    - docker build -f backend/User-Service/DockerFile -t docker.io/$DOCKER_USER/indianfoodrestro-user-service:latest backend/User-Service
    - docker push docker.io/$DOCKER_USER/indianfoodrestro-user-service:latest

  rules:
    - if: $CI_COMMIT_BRANCH == "master"
   #- if: $CI_COMMIT_BRANCH == "R2026.1"