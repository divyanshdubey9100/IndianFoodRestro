stages:
  - build-frontend
  - build-backend
  - docker-deploy

variables:
  # Using the same cache paths as your working setup
  CACHE_NPM_PATH: webapp/node_modules/
  CACHE_MAVEN_PATH: .m2/repository
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: tcp://docker:2375
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - $CACHE_NPM_PATH
    - $CACHE_MAVEN_PATH

##################################################
# STAGE 1: Build Frontend (Matches GitHub Logic)
##################################################
build-frontend:
  image: node:20
  stage: build-frontend
  script:
    - cd webapp
    - npm ci
    # Matches your GitHub command:
    - npm run build -- --configuration production
  artifacts:
    paths:
      - webapp/dist/

##################################################
# STAGE 2A: Build Backend - Auth Service
##################################################
build-Auth-Service:
  image: maven:3.9.6-eclipse-temurin-21
  stage: build-backend
  
  # 1. Define the Service (Like GitHub 'services')
  services:
    - name: postgres:15-alpine
      alias: postgres-db
  
  # 2. Define DB Credentials (Matches GitHub 'env')
  variables:
    POSTGRES_DB: indian_food_db
    POSTGRES_USER: indian_food_restro
    POSTGRES_PASSWORD: indian_food_restro

  before_script:
    # 3. Health Check replacement (GitLab doesn't support 'options: --health-cmd' natively like GitHub)
    - apt-get update && apt-get install -y netcat-openbsd
    - echo "Waiting for database at postgres-db:5432..."
    - |
      for i in {1..30}; do
        if nc -z postgres-db 5432; then
          echo "Port Open! Waiting 10s for full initialization..."
          sleep 10 # Extra safety buffer for user creation
          break
        fi
        echo "Waiting..."
        sleep 2
      done

  script:
    - cd backend/Auth-Service
    # 4. Force Connection Settings (Matches GitHub mvn command)
    # We change 'localhost' to 'postgres-db' because GitLab networking requires the alias
    - mvn -B clean verify -Dspring.datasource.url=jdbc:postgresql://postgres-db:5432/indian_food_db -Dspring.datasource.username=indian_food_restro -Dspring.datasource.password=indian_food_restro -Dspring.jpa.hibernate.ddl-auto=create-drop
    # Clean up artifact to prevent Docker issues
    - rm -f target/*.original

  artifacts:
    paths:
      - backend/Auth-Service/target/*.jar

##################################################
# STAGE 2B: Build Backend - User Service
##################################################
build-User-Service:
  image: maven:3.9.6-eclipse-temurin-21
  stage: build-backend
  
  services:
    - name: postgres:15-alpine
      alias: postgres-db
  
  variables:
    POSTGRES_DB: indian_food_db
    POSTGRES_USER: indian_food_restro
    POSTGRES_PASSWORD: indian_food_restro

  before_script:
    - apt-get update && apt-get install -y netcat-openbsd
    - |
      for i in {1..30}; do
        if nc -z postgres-db 5432; then
          sleep 10
          break
        fi
        sleep 2
      done

  script:
    - cd backend/User-Service
    - mvn -B clean verify -Dspring.datasource.url=jdbc:postgresql://postgres-db:5432/indian_food_db -Dspring.datasource.username=indian_food_restro -Dspring.datasource.password=indian_food_restro -Dspring.jpa.hibernate.ddl-auto=create-drop
    - rm -f target/*.original
  
  artifacts:
    paths:
      - backend/User-Service/target/*.jar

##################################################
# STAGE 3: Docker Deploy (Matches GitHub Steps)
##################################################
docker-deploy:
  image: docker:24.0.5
  stage: docker-deploy
  services:
    - name: docker:24.0.5-dind
      alias: docker
  
  needs:
    - build-frontend
    - build-Auth-Service
    - build-User-Service
  
  before_script:
    # Login using GitLab Secrets (Assuming you named them same as GitHub)
    - docker login -u "$DOCKER_USER" -p "$DOCKER_PASSWORD" docker.io
  
  script:
    # Frontend
    - cd webapp
    - docker build -f DockerFile -t docker.io/$DOCKER_USER/indianfoodrestro-frontend:latest .
    - docker push docker.io/$DOCKER_USER/indianfoodrestro-frontend:latest
    - cd ..

    # Auth Service
    - cd backend/Auth-Service
    - docker build -f DockerFile -t docker.io/$DOCKER_USER/indianfoodrestro-auth-service:latest .
    - docker push docker.io/$DOCKER_USER/indianfoodrestro-auth-service:latest
    - cd ../..

    # User Service
    - cd backend/User-Service
    - docker build -f DockerFile -t docker.io/$DOCKER_USER/indianfoodrestro-user-service:latest .
    - docker push docker.io/$DOCKER_USER/indianfoodrestro-user-service:latest

  rules:
    - if: $CI_COMMIT_BRANCH == "master"