stages:
  - build-frontend
  - build-backend
  - docker-deploy

variables:
  CACHE_NPM_PATH: webapp/node_modules/
  CACHE_MAVEN_PATH: .m2/repository
  # Required for Docker-in-Docker (DinD)
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: tcp://docker:2375

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - $CACHE_NPM_PATH
    - $CACHE_MAVEN_PATH

############################
# Frontend Build (Unchanged)
############################
build-frontend:
  image: node:20
  stage: build-frontend
  script:
    - cd webapp
    - npm ci --include=dev
    - npx ng version
    - npx ng build --configuration production --optimization=false
  artifacts:
    paths:
      - webapp/dist/

############################
# Backend Build - Auth Service (Unchanged)
############################
build-Auth-Service:
  image: maven:3.9.6-eclipse-temurin-21
  stage: build-backend
  script:
    - cd backend/Auth-Service
    - mvn clean install
  artifacts:
    paths:
      - backend/Auth-Service/target/

############################
# Backend Build - User Service (Unchanged)
############################
build-User-Service:
  image: maven:3.9.6-eclipse-temurin-21
  stage: build-backend
  script:
    - cd backend/User-Service
    - mvn clean install
  artifacts:
    paths:
      - backend/User-Service/target/

############################
# Docker Build & Push (Updated)
############################
docker-deploy:
  image: docker:24.0.5
  stage: docker-deploy
  services:
    - name: docker:24.0.5-dind
      alias: docker
  
  needs:
    - build-frontend
    - build-Auth-Service
    - build-User-Service
  
  before_script:
    # Login to Docker Hub using variables defined in GitLab Settings
    - docker login -u "$DOCKER_USER" -p "$DOCKER_PASSWORD" docker.io
  
  script:
    # Frontend Docker Image
    - docker build -f webapp/DockerFile -t docker.io/$DOCKER_USER/indianfoodrestro-frontend:latest webapp
    - docker push docker.io/$DOCKER_USER/indianfoodrestro-frontend:latest

    # Auth Service Docker Image
    - docker build -f backend/Auth-Service/DockerFile -t docker.io/$DOCKER_USER/indianfoodrestro-auth-service:latest backend/Auth-Service
    - docker push docker.io/$DOCKER_USER/indianfoodrestro-auth-service:latest

    # User Service Docker Image
    - docker build -f backend/User-Service/DockerFile -t docker.io/$DOCKER_USER/indianfoodrestro-user-service:latest backend/User-Service
    - docker push docker.io/$DOCKER_USER/indianfoodrestro-user-service:latest

  rules:
    # Runs if branch is 'master' OR 'R2026.1'
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_COMMIT_BRANCH == "R2026.1"