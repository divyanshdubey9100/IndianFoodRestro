stages:
  - build-frontend
  - build-backend
  - docker-deploy

variables:
  CACHE_NPM_PATH: webapp/node_modules/
  CACHE_MAVEN_PATH: .m2/repository
  # Required for Docker-in-Docker to work securely with recent versions
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: tcp://docker:2375

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - $CACHE_NPM_PATH
    - $CACHE_MAVEN_PATH

############################
# Frontend Build
############################
build-frontend:
  image: node:20
  stage: build-frontend
  script:
    - cd webapp
    - npm ci --include=dev
    - npx ng version
    - npx ng build --configuration production --optimization=false
  artifacts:
    name: "angular-dist"
    paths:
      # Matches GitHub: Preserves the dist folder
      - webapp/dist/
    expire_in: 1 hour

############################
# Backend Build - Auth Service
############################
build-Auth-Service:
  image: maven:3.9.6-eclipse-temurin-21
  stage: build-backend
  script:
    - cd backend/Auth-Service
    - mvn clean verify
    # Safety step to match GitHub logic
    - rm -f target/*.original
  artifacts:
    name: "auth-service-jar"
    paths:
      - backend/Auth-Service/target/
    expire_in: 1 hour

############################
# Backend Build - User Service
############################
build-User-Service:
  image: maven:3.9.6-eclipse-temurin-21
  stage: build-backend
  script:
    - cd backend/User-Service
    - mvn clean verify
    - rm -f target/*.original
  artifacts:
    name: "user-service-jar"
    paths:
      - backend/User-Service/target/
    expire_in: 1 hour

############################
# Docker Build & Push (To Docker Hub)
############################
docker-deploy:
  # Use the stable docker image
  image: docker:24.0.5
  stage: docker-deploy
  services:
    # Explicitly use dind (Docker-in-Docker)
    - name: docker:24.0.5-dind
      alias: docker
  
  needs:
    - build-frontend
    - build-Auth-Service
    - build-User-Service
    
  before_script:
    # UPDATED: Log in to Docker Hub (matches GitHub behavior)
    # Ensure you have set DOCKER_USER and DOCKER_PASSWORD in GitLab CI/CD Variables
    - docker login -u "$DOCKER_USER" -p "$DOCKER_PASSWORD" docker.io
    
  script:
    # 1. Frontend Docker Image
    # Note: We build from 'webapp' context, matching GitHub
    - docker build -f webapp/DockerFile -t docker.io/$DOCKER_USER/indianfoodrestro-frontend:latest webapp
    - docker push docker.io/$DOCKER_USER/indianfoodrestro-frontend:latest

    # 2. Auth Service Docker Image
    - docker build -f backend/Auth-Service/DockerFile -t docker.io/$DOCKER_USER/indianfoodrestro-auth-service:latest backend/Auth-Service
    - docker push docker.io/$DOCKER_USER/indianfoodrestro-auth-service:latest

    # 3. User Service Docker Image
    - docker build -f backend/User-Service/DockerFile -t docker.io/$DOCKER_USER/indianfoodrestro-user-service:latest backend/User-Service
    - docker push docker.io/$DOCKER_USER/indianfoodrestro-user-service:latest

  rules:
    # UPDATED: Matches GitHub's "master" branch trigger
    - if: $CI_COMMIT_BRANCH == "master"